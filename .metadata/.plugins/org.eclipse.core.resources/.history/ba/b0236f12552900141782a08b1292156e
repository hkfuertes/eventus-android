package es.hkapps.eventus.view.wall;

import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;

import es.hkapps.eventus.R;
import es.hkapps.eventus.model.PhotoEntry;
import es.hkapps.eventus.model.TextEntry;
import es.hkapps.eventus.model.WallEntry;
import android.app.Activity;
import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.drawable.Drawable;
import android.os.AsyncTask;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.TextView;

public class WallAdapter extends BaseAdapter {

	private LayoutInflater layoutInflater;
	private ArrayList<WallEntry> feed;
	private Context context;

	public WallAdapter(Activity activity, ArrayList<WallEntry> feed) {
		this.context = activity;
		this.feed = feed;

		layoutInflater = (LayoutInflater) activity
				.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
	}

	@Override
	public int getCount() {
		// Set the total list item count
		return feed.size();
	}

	@Override
	public WallEntry getItem(int position) {
		return feed.get(position);
	}

	@Override
	public long getItemId(int position) {
		return position;
	}

	@Override
	public View getView(int position, View convertView, ViewGroup parent) {

		// Inflate the item layout and set the views
		View listItem = convertView;
		if (listItem == null) {
			listItem = layoutInflater.inflate(R.layout.wall_list_item, null);
		}

		FrameLayout photo = (FrameLayout) listItem
				.findViewById(R.id.wall_list_photo);
		TextView text = (TextView) listItem.findViewById(R.id.wall_list_text);

		WallEntry entry;
		if ((entry = this.getItem(position)) instanceof PhotoEntry) {
			PhotoEntry pEntry = (PhotoEntry) entry;
			// (new DownloadImageTask(photo)).execute(pEntry.getPhoto());
			Drawable drw = ImageOperations(context, pEntry.getPhoto(), "temp_"
					+ position);
			photo.setBackgroundDrawable(drw);
			text.setText(pEntry.getText());
		} else {
			TextEntry tEntry = (TextEntry) entry;
			text.setText(tEntry.getText());
			photo.setVisibility(View.GONE);
		}

		return listItem;
	}

	private Drawable ImageOperations(Context ctx, String url,
			String saveFilename) {
		try {
			InputStream is = (InputStream) this.fetch(url);
			Drawable d = Drawable.createFromStream(is, saveFilename);
			return d;
		} catch (MalformedURLException e) {
			e.printStackTrace();
			return null;
		} catch (IOException e) {
			e.printStackTrace();
			return null;
		}
	}

	public Object fetch(String address) throws MalformedURLException,
			IOException {
		URL url = new URL(address);
		Object content = url.getContent();
		return content;
	}
}
